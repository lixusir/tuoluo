// eval(function(p,a,c,k,e,d){e=function(c){return(c<a?'':e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--){d[e(c)]=k[c]||e(c)}k=[function(e){return d[e]}];e=function(){return'\\w+'};c=1};while(c--){if(k[c]){p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c])}}return p}('2p([\'l\',\'1t\'],4(l,1t,2q){5 3={q:v,x:0,A:0,2o:0,T:0,H:0};3.2n=4(1c){3.q=q=1c.q;3.k=q=1c.k;5 2k=v;6(1N(18.1m)!==\'1R\'){3.x=18.1m;3.A=3.x.9;$("#2l").19(3.x.x);$("#2m").7().o("1y").19(3.x.2r);$("#2s").7().o("1y").19(3.x.2z);2x 18.1m}$(\'.E-2t .L-1\').e(4(){6(3.q.16>0&&3.A<1){f.K.7("请选择收货地址!");B}3.1E(v)});$(\'.t-n\').G(\'e\').e(4(){5 P=$(c).h(\'P\');3.n(P)});$(\'.t-Y\').G(\'e\').e(4(){5 D=$(c).h(\'D\');f.1u(\'确认已收到货了吗?\',\'提示\',4(){3.Y(D)})});$(\'.t-1a\').G(\'e\').e(4(){5 D=$(c).h(\'D\');f.1u(\'确认领取红包吗?\',\'提示\',4(){3.1a(D)})});$(\'.2A-2h\').e(4(){5 h=$(c).M(\'h\');5 9="28"+h;5 s=$(c).M(\'s\');6(s==\'1\'){$("."+9).24()}i{$("."+9).2b()}$(c).M(\'s\',s==\'1\'?\'0\':\'1\')});6($(\'#1B\').2g>0){5 C=[];5 1w=1f 2c.2d();1w.26(4(r){5 29=c;6(c.2f()==2i){5 V=r.1x.V,X=r.1x.X;$(\'.1A-2a\').1z(4(){5 g=$(c).o(\'.g\');5 1p=$(c).h(\'X\'),1l=$(c).h(\'V\');6(1p>0&&1l>0){5 y=l.25(X,V,1p,1l);$(c).h(\'y\',y);g.F(\'距离您: \'+y.31(2)+"30").7()}i{$(c).h(\'y\',2Z);g.F(\'无法获得距离\').7()}C.2Y($(c))});C.2B(4(a,b){B a.h(\'y\')-b.h(\'y\')});$.1z(C,4(){$(\'.1A-O\').1F(c)});$(\'#1B\').7();$(\'#1i\').1F($(C[0]).F());5 g=$(\'#1i\').o(\'.g\').F();$(\'#1i\').o(\'.g\').F(g+"<1D 33=\'E-1C E-1C-W\'>最近</1D> ");$(C[0]).2V()}},{2U:m})}};3.Y=4(9){l.j(\'R/k/Y\',{9:9},4(J){6(J.15==1){g.1k();B}f.K.7(J.d)},m,m)};3.1a=4(9){l.j(\'R/k/2H\',{9:9},4(J){6(J.15==1){1s(4(){f.N.7({2I:"恭喜您，红包领取成功!",p:\'p p-1h\',13:\'\',1r:[{w:\'确定\',z:\'L-W\',I:4(){g.1k();B}}]})},1)}i{f.K.7(J.d.N)}},m,m)};3.1E=4(1G){f.2J.7("选择支付方式",[{w:\'微信支付\',z:\'8\',I:4(){3.1d(\'8\')}},{w:\'支付宝支付\',z:\'u\',I:4(){3.1d(\'u\')}},],1G)};3.n=4(P){O=1f 2F({13:$(".t-n-10").F(),z:"2C-3",2D:4(){O.14()}});O.7();$(\'.n-11\').o(\'.14\').G(\'e\').e(4(){O.14()});l.j(\'2E/n/2K\',{9:P},4(1e){6(1e.15==0){f.2R(\'生成出错，请刷新重试!\');B}5 1v=+1f 2S();$(\'.n-11\').o(\'.1K\').M(\'1M\',1e.d.Z+"?2Q="+1v).7()},v,m)};3.1d=4(1o){6(3.q.2P==0&&3.q.16>0){5 S=\'确认兑换并支付运费吗？\';3.T=1}i{5 S=\'确认兑换吗?\';3.T=0}f.N.7({p:\'p p-2M\',13:S,1r:[{w:\'确定\',z:\'L-W\',I:4(){1s(4(){l.j(\'R/k/1I\',{9:3.k.9,A:3.A,1o:1o},4(j){5 d=j.d;6(3.T){6(d.8){5 8=d.8;6(8.2N){4 Q(){1O.2O(\'2X\',{\'1W\':8.1X?8.1X:8.1W,\'1V\':8.1V,\'1H\':8.1H,\'20\':8.20,\'1Z\':8.1Z,\'22\':8.22,},4(1g){6(1g.1U==\'1L:2L\'){3.12()}i 6(1g.1U==\'1L:2G\'){f.K.7(\'取消支付\')}i{l.j(\'R/k/1I\',{9:3.k.9,A:3.A,1S:1},4(1J){3.1n(1J.d.8)},v,m)}})}6(1N 1O=="1R"){6(U.1Q){U.1Q(\'1P\',Q,v)}i 6(U.17){U.17(\'1P\',Q);U.17(\'32\',Q)}}i{Q()}}i 6(d.8.34||d.8.1S==1){3.1n(8)}}i 6(d.u){5 u=d.u;6(!u.1h){f.K.7(\'支付参数错误！\')}g.37=l.1Y(\'t/36\',{9:3.k.9,35:21,Z:u.Z})}}i{3.12()}},m,m)},2W)}},{w:\'取消\',z:\'L-2T\',I:4(){}}]})};3.1n=4(8){5 1T=l.1Y(\'2w/27\',{Z:8.2e});$(\'#23\').w(3.q.16);$(\'.E-1q\').s();$(\'#2v\').G(\'e\').e(4(){1b(3.H);$(\'.t-1j-10\').s();$(\'.E-1q\').7()});$(\'.t-1j-10\').7();3.H=2u(4(){3.12()},2j);$(\'.n-11\').o(\'.14\').G(\'e\').e(4(){$(\'.t-1j-10\').s();$(\'.E-1q\').7();1b(3.H)});$(\'.n-11\').o(\'.1K\').M(\'1M\',1T).7()};3.12=4(){5 S=3.T?\'运费支付成功!\':\'兑换成功!\';l.j(\'R/k/2y\',{9:3.k.9},4(j){5 d=j.d;6(j.15!=1){6(3.H==0){f.K.7(d.N)}B}1b(3.H);f.N.7({p:\'p p-1h\',13:S,1r:[{w:\'确定\',z:\'L-W\',I:4(){g.1k()}}]})},v,m)};B 3});',62,194,'|||modal|function|var|if|show|wechat|id|||this|result|click|FoxUI|location|data|else|json|log|core|true|verify|find|icon|goods||hide|order|alipay|false|text|address|distance|extraClass|addressid|return|arr|logid|fui|html|unbind|settime|onclick|pay_json|toast|btn|attr|message|container|orderid|onBridgeReady|creditshop|tiptext|needdispatchpay|document|lat|danger|lng|finish|url|hidden|pop|payResult|content|close|status|dispatch|attachEvent|window|val|packet|clearInterval|params|payDispatch|ret|new|res|success|nearStoreHtml|weixinpay|reload|store_lat|selectedAddressData|payWechatJie|paytype|store_lng|header|buttons|setTimeout|tpl|confirm|time|geolocation|point|input|each|store|nearStore|label|span|openActionSheet|append|round|nonceStr|paydispatch|wechat_jie|qrimg|get_brand_wcpay_request|src|typeof|WeixinJSBridge|WeixinJSBridgeReady|addEventListener|undefined|jie|img|err_msg|timeStamp|appId|appid|getUrl|signType|package||paySign|qrmoney|slideDown|getDistanceByLnglat|getCurrentPosition|qr|diyinfo_|_this|item|slideUp|BMap|Geolocation|code_url|getStatus|length|diyinfo|BMAP_STATUS_SUCCESS|2000|loadAddress|address_select|carrier_realname|init|canpay|define|op|realname|carrier_mobile|footer|setInterval|btnWeixinJieCancel|index|delete|payresult|mobile|look|sort|popup|maskClick|groups|FoxUIModal|cancel|Receivepacket|title|actionsheet|qrcode|ok|information|weixin|invoke|isverify|timestamp|alert|Date|default|enableHighAccuracy|remove|1000|getBrandWCPayRequest|push|999999999999999999|km|toFixed|onWeixinJSBridgeReady|class|weixin_jie|type|pay_alipay|href'.split('|'),0,{}))

define(['core', 'tpl'], function (core, tpl, op) {
    var modal = {
        goods: false,
        address: 0,
        addressid: 0,
        canpay: 0,
        needdispatchpay: 0,
        settime: 0
    };
    modal.init = function (params) {
        modal.goods = goods = params.goods;
        modal.log = goods = params.log;
        var loadAddress = false;
        if(typeof (window.selectedAddressData) !== 'undefined') {
            modal.address = window.selectedAddressData;
            modal.addressid = modal.address.id;
            $("#address_select")
                .html(modal.address.address);
            $("#carrier_realname")
                .show()
                .find("input")
                .val(modal.address.realname);
            $("#carrier_mobile")
                .show()
                .find("input")
                .val(modal.address.mobile);
            delete window.selectedAddressData
        }
        $('.fui-footer .btn-1')
            .click(function () {
                if(modal.goods.dispatch >= 0 && modal.addressid < 1) {
                    FoxUI.toast.show("请选择收货地址!");
                    return
                }
                modal.openActionSheet(false)
            });
        $('.order-verify')
            .unbind('click')
            .click(function () {
                var orderid = $(this)
                    .data('orderid');
                modal.verify(orderid)
            });
        $('.order-finish')
            .unbind('click')
            .click(function () {
                var logid = $(this)
                    .data('logid');
                FoxUI.confirm('确认已收到货了吗?', '提示', function () {
                    modal.finish(logid)
                })
            });
        $('.order-packet')
            .unbind('click')
            .click(function () {
                var logid = $(this)
                    .data('logid');
                FoxUI.confirm('确认领取红包吗?', '提示', function () {
                    modal.packet(logid)
                })
            });
        $('.look-diyinfo')
            .click(function () {
                var data = $(this)
                    .attr('data');
                var id = "diyinfo_" + data;
                var hide = $(this)
                    .attr('hide');
                if(hide == '1') {
                    $("." + id)
                        .slideDown()
                } else {
                    $("." + id)
                        .slideUp()
                }
                $(this)
                    .attr('hide', hide == '1' ? '0' : '1')
            });
        if($('#nearStore')
            .length > 0) {
            var arr = [];
            var geolocation = new BMap.Geolocation();
            geolocation.getCurrentPosition(function (r) {
                var _this = this;
                if(this.getStatus() == BMAP_STATUS_SUCCESS) {
                    var lat = r.point.lat,
                        lng = r.point.lng;
                    $('.store-item')
                        .each(function () {
                            var location = $(this)
                                .find('.location');
                            var store_lng = $(this)
                                    .data('lng'),
                                store_lat = $(this)
                                    .data('lat');
                            if(store_lng > 0 && store_lat > 0) {
                                var distance = core.getDistanceByLnglat(lng, lat, store_lng, store_lat);
                                $(this)
                                    .data('distance', distance);
                                location.html('距离您: ' + distance.toFixed(2) + "km")
                                    .show()
                            } else {
                                $(this)
                                    .data('distance', 999999999999999999);
                                location.html('无法获得距离')
                                    .show()
                            }
                            arr.push($(this))
                        });
                    arr.sort(function (a, b) {
                        return a.data('distance') - b.data('distance')
                    });
                    $.each(arr, function () {
                        $('.store-container')
                            .append(this)
                    });
                    $('#nearStore')
                        .show();
                    $('#nearStoreHtml')
                        .append($(arr[0])
                            .html());
                    var location = $('#nearStoreHtml')
                        .find('.location')
                        .html();
                    $('#nearStoreHtml')
                        .find('.location')
                        .html(location + "<span class='fui-label fui-label-danger'>最近</span> ");
                    $(arr[0])
                        .remove()
                }
            }, {
                enableHighAccuracy: true
            })
        }
    };
    modal.finish = function (id) {
        core.json('creditshop/log/finish', {
            id: id
        }, function (pay_json) {
            if(pay_json.status == 1) {
                location.reload();
                return
            }
            FoxUI.toast.show(pay_json.result)
        }, true, true)
    };
    modal.packet = function (id) {
        core.json('creditshop/log/Receivepacket', {
            id: id
        }, function (pay_json) {
            if(pay_json.status == 1) {
                setTimeout(function () {
                    FoxUI.message.show({
                        title: "恭喜您，红包领取成功!",
                        icon: 'icon icon-success',
                        content: '',
                        buttons: [{
                            text: '确定',
                            extraClass: 'btn-danger',
                            onclick: function () {
                                location.reload();
                                return
                            }
                        }]
                    })
                }, 1)
            } else {
                FoxUI.toast.show(pay_json.result.message)
            }
        }, true, true)
    };
    modal.openActionSheet = function (round) {
        FoxUI.actionsheet.show("选择支付方式", [{
            text: '微信支付',
            extraClass: 'wechat',
            onclick: function () {
                modal.payDispatch('wechat')
            }
        }, {
            text: '支付宝支付',
            extraClass: 'alipay',
            onclick: function () {
                modal.payDispatch('alipay')
            }
        }, ], round)
    };
    modal.verify = function (orderid) {
        container = new FoxUIModal({
            content: $(".order-verify-hidden")
                .html(),
            extraClass: "popup-modal",
            maskClick: function () {
                container.close()
            }
        });
        container.show();
        $('.verify-pop')
            .find('.close')
            .unbind('click')
            .click(function () {
                container.close()
            });
        core.json('groups/verify/qrcode', {
            id: orderid
        }, function (ret) {
            if(ret.status == 0) {
                FoxUI.alert('生成出错，请刷新重试!');
                return
            }
            var time = +new Date();
            $('.verify-pop')
                .find('.qrimg')
                .attr('src', ret.result.url + "?timestamp=" + time)
                .show()
        }, false, true)
    };
    modal.payDispatch = function (paytype) {
        if(modal.goods.isverify == 0 && modal.goods.dispatch > 0) {
            var tiptext = '确认兑换并支付运费吗？';
            modal.needdispatchpay = 1
        } else {
            var tiptext = '确认兑换吗?';
            modal.needdispatchpay = 0
        }
        FoxUI.message.show({
            icon: 'icon icon-information',
            content: tiptext,
            buttons: [{
                text: '确定',
                extraClass: 'btn-danger',
                onclick: function () {
                    setTimeout(function () {
                        core.json('creditshop/log/paydispatch', {
                            id: modal.log.id,
                            addressid: modal.addressid,
                            paytype: paytype
                        }, function (json) {
                            if(json.status != 1) {
                                FoxUI.toast.show(json.result.message)
                                return
                            }
                            var result = json.result;
                            if(modal.needdispatchpay) {
                                if(result.wechat) {
                                    var wechat = result.wechat;
                                    if(wechat.weixin) {
                                        function onBridgeReady() {
                                            WeixinJSBridge.invoke('getBrandWCPayRequest', {
                                                'appId': wechat.appid ? wechat.appid : wechat.appId,
                                                'timeStamp': wechat.timeStamp,
                                                'nonceStr': wechat.nonceStr,
                                                'package': wechat.package,
                                                'signType': wechat.signType,
                                                'paySign': wechat.paySign,
                                            }, function (res) {
                                                if(res.err_msg == 'get_brand_wcpay_request:ok') {
                                                    modal.payResult()
                                                } else if(res.err_msg == 'get_brand_wcpay_request:cancel') {
                                                    FoxUI.toast.show('取消支付')
                                                } else {
                                                    core.json('creditshop/log/paydispatch', {
                                                        id: modal.log.id,
                                                        addressid: modal.addressid,
                                                        jie: 1
                                                    }, function (wechat_jie) {
                                                        modal.payWechatJie(wechat_jie.result.wechat)
                                                    }, false, true)
                                                }
                                            })
                                        }
                                        if(typeof WeixinJSBridge == "undefined") {
                                            if(document.addEventListener) {
                                                document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false)
                                            } else if(document.attachEvent) {
                                                document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
                                                document.attachEvent('onWeixinJSBridgeReady', onBridgeReady)
                                            }
                                        } else {
                                            onBridgeReady()
                                        }
                                    } else if(result.wechat.weixin_jie || result.wechat.jie == 1) {
                                        modal.payWechatJie(wechat)
                                    }
                                } else if(result.alipay) {
                                    var alipay = result.alipay;
                                    if(!alipay.success) {
                                        FoxUI.toast.show('支付参数错误！')
                                    }
                                    location.href = core.getUrl('order/pay_alipay', {
                                        id: modal.log.id,
                                        type: 21,
                                        url: alipay.url
                                    })
                                }
                            } else {
                                modal.payResult()
                            }
                        }, true, true)
                    }, 1000)
                }
            }, {
                text: '取消',
                extraClass: 'btn-default',
                onclick: function () {}
            }]
        })
    };
    modal.payWechatJie = function (wechat) {
        var img = core.getUrl('index/qr', {
            url: wechat.code_url
        });
        $('#qrmoney')
            .text(modal.goods.dispatch);
        $('.fui-header')
            .hide();
        $('#btnWeixinJieCancel')
            .unbind('click')
            .click(function () {
                clearInterval(modal.settime);
                $('.order-weixinpay-hidden')
                    .hide();
                $('.fui-header')
                    .show()
            });
        $('.order-weixinpay-hidden')
            .show();
        modal.settime = setInterval(function () {
            modal.payResult()
        }, 2000);
        $('.verify-pop')
            .find('.close')
            .unbind('click')
            .click(function () {
                $('.order-weixinpay-hidden')
                    .hide();
                $('.fui-header')
                    .show();
                clearInterval(modal.settime)
            });
        $('.verify-pop')
            .find('.qrimg')
            .attr('src', img)
            .show()
    };
    modal.payResult = function () {
        var tiptext = modal.needdispatchpay ? '运费支付成功!' : '兑换成功!';
        core.json('creditshop/log/payresult', {
            id: modal.log.id
        }, function (json) {
            var result = json.result;
            if(json.status != 1) {
                if(modal.settime == 0) {
                    FoxUI.toast.show(result.message)
                }
                return
            }
            clearInterval(modal.settime);
            FoxUI.message.show({
                icon: 'icon icon-success',
                content: tiptext,
                buttons: [{
                    text: '确定',
                    extraClass: 'btn-danger',
                    onclick: function () {
                        location.reload()
                    }
                }]
            })
        }, false, true)
    };
    return modal
});